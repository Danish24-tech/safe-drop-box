//Danish

#include "stm32f4xx.h"

/* ================= PART 1 â€“ INITIALIZATION & INTERRUPT ================= */
/* ================= CONFIGURATION ================= */
volatile uint32_t msTicks;

/* ================= INTERRUPT ================= */
// SysTick interrupt increments msTicks every 1 ms
void SysTick_Handler(void) {
    msTicks++;
}

/* ================= SUBROUTINE ================= */
// Delay subroutine using SysTick
void delay_ms(uint32_t ms) {
    uint32_t start = msTicks;
    while ((msTicks - start) < ms);
}

/* ================= BUTTON (PA3) ================= */
void Button_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~(3U << (3 * 2));
    GPIOA->PUPDR &= ~(3U << (3 * 2));
    GPIOA->PUPDR |=  (2U << (3 * 2)); // Pull-down
}

uint8_t Button_Pressed(void) {
    return (GPIOA->IDR & (1 << 3)) != 0;
}

/* ================= LED (PC9) ================= */
void LED_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN;

    GPIOC->MODER &= ~(3U << (9 * 2));
    GPIOC->MODER |=  (1U << (9 * 2));
}

void LED_On(void)  { GPIOC->ODR |=  (1 << 9); }
void LED_Off(void) { GPIOC->ODR &= ~(1 << 9); }

/* ================= IR SENSOR (PA1) ================= */
void IR_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~(3U << (1 * 2));
    GPIOA->PUPDR &= ~(3U << (1 * 2));
    GPIOA->PUPDR |=  (1U << (1 * 2)); // Pull-up
}

// Returns 1 if item detected (active low)
uint8_t IR_Detected(void) {
    return (GPIOA->IDR & (1 << 1)) == 0;
}
