//Danish

#include "stm32f4xx.h"

/* ================= PART 1 – INITIALIZATION & INTERRUPT ================= */
/* ================= CONFIGURATION ================= */
volatile uint32_t msTicks;

/* ================= INTERRUPT ================= */
// SysTick interrupt increments msTicks every 1 ms
void SysTick_Handler(void) {
    msTicks++;
}

/* ================= SUBROUTINE ================= */
// Delay subroutine using SysTick
void delay_ms(uint32_t ms) {
    uint32_t start = msTicks;
    while ((msTicks - start) < ms);
}

/* ================= BUTTON (PA3) ================= */
void Button_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~(3U << (3 * 2));
    GPIOA->PUPDR &= ~(3U << (3 * 2));
    GPIOA->PUPDR |=  (2U << (3 * 2)); // Pull-down
}

uint8_t Button_Pressed(void) {
    return (GPIOA->IDR & (1 << 3)) != 0;
}

/* ================= LED (PC9) ================= */
void LED_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN;

    GPIOC->MODER &= ~(3U << (9 * 2));
    GPIOC->MODER |=  (1U << (9 * 2));
}

void LED_On(void)  { GPIOC->ODR |=  (1 << 9); }
void LED_Off(void) { GPIOC->ODR &= ~(1 << 9); }

/* ================= IR SENSOR (PA1) ================= */
void IR_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~(3U << (1 * 2));
    GPIOA->PUPDR &= ~(3U << (1 * 2));
    GPIOA->PUPDR |=  (1U << (1 * 2)); // Pull-up
}

// Returns 1 if item detected (active low)
uint8_t IR_Detected(void) {
    return (GPIOA->IDR & (1 << 1)) == 0;
}

//Khairi

/* ================= PART 2 – SERVO PWM ================= */

/* ================= SERVO (PA0 - TIM2 CH1) ================= */
void TIM2_PWM_Init(void) {
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~(3U << 0);
    GPIOA->MODER |=  (2U << 0);
    GPIOA->AFR[0] |=  (1U << 0); // AF1

    TIM2->PSC = 16 - 1;      
    TIM2->ARR = 20000 - 1;   
    TIM2->CCMR1 |= (6 << 4);
    TIM2->CR1 |= TIM_CR1_CEN;

    // PWM disabled at startup; servo stays still
    TIM2->CCER &= ~TIM_CCER_CC1E;
}

// Subroutine to move servo to position for a specific time
void Servo_Go(uint32_t pos, uint32_t moveTime) {
    TIM2->CCR1 = pos;
    TIM2->CCER |= TIM_CCER_CC1E;
    delay_ms(moveTime);       // call to subroutine
    TIM2->CCER &= ~TIM_CCER_CC1E;
}
